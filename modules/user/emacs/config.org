#+TITLE: Nilso's GNU Emacs Config
#+AUTHOR: Nilso Junior
#+DESCRIPTION: Nilso's Emacs config

* Early-Init
#+begin_src emacs-lisp :tangle early-init.el
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)

  (setq inhibit-message t ;; Remove messages for startup
        initial-buffer-choice nil
        inhibit-x-resources t)
#+end_src
* Startup
#+begin_src emacs-lisp
  (defun nj/restore-message ()
    (setq inhibit-message nil)
    (remove-hook 'emcas-startup-hook 'nj/restore-message))

  (add-hook 'emacs-startup-hook 'nj/restore-message) ;; Restore message and remove hook
#+end_src

* Evil Mode
** Before Evil
#+begin_src emacs-lisp
  (setq-default indent-tabs-mode nil
                tab-width 4)

  (setq evil-want-C-u-scroll t
        evil-want-C-u-delete t
        evil-want-Y-yank-to-eol t
        evil-want-keybinding nil
        select-enable-clipboard nil
        evil-shift-width 4
        evil-insert-state-cursor '(box))
#+end_src

*** Undo
#+begin_src emacs-lisp
  (setq evil-undo-system 'undo-fu)
  (undo-fu-session-global-mode)
#+end_src

*** Splits
#+begin_src emacs-lisp
  (setq evil-vsplit-window-right t
        evil-split-window-below t)
#+end_src

** Load Evil
#+begin_src emacs-lisp
  (require 'evil)
  (evil-mode 1)

  (setq evil-collection-setup-minibuffer t)
  (require 'evil-collection)
  (evil-collection-init)

  (require 'evil-commentary)
  (evil-commentary-mode 1)
#+end_src

*** Keybindings

**** Cursor
These remaps make the cursor stay centered in the screen while navigating.
#+begin_src emacs-lisp
  (defun nj/scroll-down ()
    (interactive)
    (evil-scroll-down nil)
    (evil-scroll-line-to-center nil))

  (defun nj/scroll-up ()
    (interactive)
    (evil-scroll-up nil)
    (evil-scroll-line-to-center nil))

  (defun nj/search-next ()
    (interactive)
    (evil-search-next)
    (evil-scroll-line-to-center nil))

  (defun nj/search-previous ()
    (interactive)
    (evil-search-previous)
    (evil-scroll-line-to-center nil))

  (defun nj/up ()
    (interactive)
    (call-interactively 'evil-previous-line)
    (evil-scroll-line-to-center nil))

  (defun nj/down ()
    (interactive)
    (call-interactively 'evil-next-line)
    (evil-scroll-line-to-center nil))

  (defun nj/insert-blank-line-above (n)
    (interactive "p")
    (save-excursion
      (beginning-of-line)
      (open-line n))
    (when (bolp) (forward-char n)))

  (defun nj/insert-blank-line-below (n)
    (interactive "p")
    (save-excursion
      (end-of-line)
      (open-line n)))

  (evil-define-key 'normal global-map
    (kbd "C-u") 'nj/scroll-up
    (kbd "C-d") 'nj/scroll-down
    (kbd "k") 'nj/up
    (kbd "j") 'nj/down
    (kbd "C-p") 'universal-argument
    (kbd "C-a") 'nj/insert-blank-line-below
    (kbd "C-S-a") 'nj/insert-blank-line-above
    (kbd "n") 'nj/search-next
    (kbd "N") 'nj/search-previous)
#+end_src

**** Visual Mode
Stay in visual mode while indenting.
#+begin_src emacs-lisp
  (defun nj/indent-right ()
    (interactive)
    (evil-shift-right (region-beginning) (region-end))
    (evil-normal-state)
    (evil-visual-restore))

  (defun nj/indent-left ()
    (interactive)
    (evil-shift-left (region-beginning) (region-end))
    (evil-normal-state)
    (evil-visual-restore))

  (define-key evil-visual-state-map (kbd ">") 'nj/indent-right)
  (define-key evil-visual-state-map (kbd "<") 'nj/indent-left)
#+end_src

** Yank
Highlight text when yanking.
#+begin_src emacs-lisp
  (defun highlight-on-yank (orig-fn beg end &rest args)
    (apply orig-fn beg end args)
    (let ((ov (make-overlay beg end)))
      (overlay-put ov 'face 'show-paren-mismatch)
      (run-with-timer 0.040 nil 'delete-overlay ov)))

  (advice-add 'evil-yank :around #'highlight-on-yank)
#+end_src

* Visuals
#+begin_src emacs-lisp
  (blink-cursor-mode -1)
  (set-fringe-mode 0)

  (setq display-line-numbers-type 'relative)
  (global-display-line-numbers-mode 1)
  (global-visual-line-mode -1) ;; Disable line wrapping
  (setq-default truncate-lines t)
#+end_src

** Face Attributes
#+begin_src emacs-lisp
  (set-cursor-color (face-foreground 'default)) ;; Theme cursor based on colorscheme

  (set-face-attribute 'default nil :weight 'bold)

  ;; (set-face-attribute 'mode-line nil
  ;; 					:inherit 'default
  ;; :background 'unspecified
  ;; :foreground 'unspecified)

  (set-face-attribute 'mode-line-inactive nil
  					:inherit 'mode-line
  					:background 'unspecified)

  (defun nj/inherit-background (faces)
    (dolist (face faces)
      (set-face-attribute face nil
  						:inherit 'default
  						:background 'unspecified)))

  (nj/inherit-background
   '(fringe
     tooltip
     line-number
     line-number-current-line))
  ;; mode-line-inactive))
#+end_src

** Mode Line
#+begin_src emacs-lisp
  (defun nj/buffer-name ()
    (if (buffer-file-name)
        (if-let* ((p (project-current))
  				(p-root (project-root p))
  				(p-name (project-name p)))
  		  ;; (format "%s/%s" p-name
  		  (format "%s"
  				  (file-relative-name (buffer-file-name) p-root))
  		(abbreviate-file-name (buffer-file-name)))
      (buffer-name)))

  (setq-default mode-line-format
  			  '("%e"
  				(" ")
  				(:propertize
  				 (:eval (nj/buffer-name))
  				 )))
#+end_src

* Keybindings
#+begin_src emacs-lisp
  (require 'general)
  (general-evil-setup)

  (general-create-definer nj/leader-keys
    :states '(normal insert visual emacs)
    :keymaps 'override
    :prefix "SPC"
    :global-prefix "C-SPC")

  (nj/leader-keys
    "y" '((lambda () (interactive) (evil-use-register ?+) (call-interactively 'evil-yank)) :wk "Yank to system clipboard")
    "Y" '((lambda () (interactive) (evil-use-register ?+) (call-interactively 'evil-yank-line)) :wk "Yank to system clipboard")
    "fd" '(find-file :wk "Find file")
    "fs" '(project-find-file :wk "Find project file")
    "fa" '(project-switch-project :wk "Switch projects")
    "fj" '(switch-to-buffer :wk "Switch buffers")
    "fk" '(recentf :wk "Recent file")
    "sd" '(shell-command :wk "Shell command")
    "sf" '(async-shell-command :wk "Async shell command")
    "cf" '(recompile :wk "Recompile")
    "cv" '(compile :wk "Compile"))

  (defun nj/paste-from-system ()
    (interactive)
    (evil-paste-from-register ?+))

  (keymap-set global-map "C-S-V" 'nj/paste-from-system)
#+end_src

* WHICH-KEY
#+begin_src emacs-lisp
  (require 'which-key)
  (which-key-mode 1)
#+end_src

* ORG MODE
#+begin_src emacs-lisp
  (setq org-modern-star 'replace)
  (with-eval-after-load 'org (global-org-modern-mode))
  (require 'org-tempo)
#+end_src

* Defaults
#+begin_src emacs-lisp
  (make-directory (expand-file-name "backup/" user-emacs-directory) t)
  (make-directory (expand-file-name "auto-save/" user-emacs-directory) t)
  (make-directory (expand-file-name "lock/" user-emacs-directory) t)

  (setq backup-directory-alist
        `(("." . ,(expand-file-name "backup/" user-emacs-directory)))
        auto-save-file-name-transforms
        `((".*" ,(expand-file-name "auto-save/" user-emacs-directory) t))
        lock-file-name-transforms
        `((".*" ,(expand-file-name "lock/" user-emacs-directory) t))
        use-short-answers t)

  (setq compilation-scroll-output t)
  (setq-default compile-command '(car compile-history)) ;; Last compile command will be the default

  (defun nj/format-buffer ()
    (indent-region (point-min) (point-max))
    (message "writingasdf")
    (delete-trailing-whitespace))

  (add-hook 'before-save-hook 'nj/format-buffer)
#+end_src

* Dired
#+begin_src emacs-lisp
  ;; (setq dired-recursive-deletes 'always
  ;; 	dired-recursive-copies 'always)
  (setq dired-listing-switches "-lahv --group-directories-first"
        dired-kill-when-opening-new-dired-buffer t
        dired-auto-revert-buffer t)

  (require 'diredfl)
  (diredfl-global-mode 1)
  (set-face-attribute 'diredfl-date-time nil :weight 'unspecified :inherit 'default)
#+end_src

* Completions
This will go to the next line or previous if fido-vertica-mode is enabled. Otherwise it will navigate history.
#+begin_src emacs-lisp
  (savehist-mode 1)

  (fido-vertical-mode)
  (evil-define-key 'insert icomplete-fido-mode-map
    (kbd "C-k") 'icomplete-backward-completions
    (kbd "C-j") 'icomplete-forward-completions)

  (evil-define-key 'insert minibuffer-local-map
    (kbd "C-k") 'previous-line-or-history-element
    (kbd "C-j") 'next-line-or-history-element)
#+end_src

* Ansi Colours
#+begin_src emacs-lisp
  (require 'ansi-color)

  (add-hook 'compilation-filter-hook 'ansi-color-compilation-filter)
  (setq ansi-color-for-compilation-mode t)

  (add-hook 'comint-output-filter-functions 'ansi-color-process-output)
  (setq ansi-color-for-comint-mode t)
#+end_src

* Buffer Completions
#+begin_src emacs-lisp
  (require 'corfu)
  (global-corfu-mode)
  (corfu-history-mode)
  (corfu-popupinfo-mode)

  (require 'cape)
  (add-hook 'completion-at-point-functions #'cape-dabbrev)
  (add-hook 'completion-at-point-functions #'cape-file)
  (add-hook 'completion-at-point-functions #'cape-elisp-block)

  ;; Hide commands in M-x which do not apply to the current mode.  Corfu
  ;; commands are hidden, since they are not used via M-x. This setting is
  ;; useful beyond Corfu.
  (setq read-extended-command-predicate #'command-completion-default-include-p)

  (setq corfu-auto t
        corfu-auto-delay 0.15
        corfu-echo-delay 0.15
  	  corfu-auto-prefix 2 ;; Start completion after 2 characters
  	  corfu-popupinfo-direction '(right)
  	  corfu-border-width 2
  	  corfu-bar-width 0 ;; Disable scroll bar
  	  corfu-popupinfo-delay nil ;; We use manual toggle
  	  tab-always-indent 'complete ;; just TAB will trigger completion instead of M-TAB
  	  text-mode-ispell-word-completion nil) ;; Not sure

  (keymap-unset corfu-map "RET")
  (keymap-set corfu-map "C-<return>" 'corfu-insert)
  (evil-collection-define-key 'insert 'corfu-map
    (kbd "C-u") nil
    (kbd "C-d") 'corfu-popupinfo-toggle
    (kbd "C-n") 'corfu-popupinfo-scroll-up
    (kbd "C-p") 'corfu-popupinfo-scroll-down)
#+end_src

* Languagues

#+begin_src emacs-lisp
  (setq nix-ts-mode-indent-offset 4
        rust-ts-mode-indent-offset 4)

  (add-to-list 'auto-mode-alist '("\\.nix\\'" . nix-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.rs\\'" . rust-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.lua\\'" . lua-ts-mode))
#+end_src
