#+TITLE: Nilso's GNU Emacs Config
#+AUTHOR: Nilso Junior
#+DESCRIPTION: Nilso's Emacs config

* Evil Mode

** Before Evil
#+begin_src emacs-lisp
  (setq evil-want-C-u-scroll t
        evil-want-C-u-delete t
        evil-want-keybinding nil
        select-enable-clipboard nil
        evil-shift-width 4
        evil-insert-state-cursor '(box))
#+end_src

*** Undo
#+begin_src emacs-lisp
  (setq evil-undo-system 'undo-fu)
  (undo-fu-session-global-mode)
#+end_src

*** Splits
#+begin_src emacs-lisp
  (setq evil-vsplit-window-right t
        evil-split-window-below t)
#+end_src

** Load Evil
#+begin_src emacs-lisp
  (require 'evil)
  (evil-mode 1)

  (setq evil-collection-setup-minibuffer t)
  (require 'evil-collection)
  (evil-collection-init)

  (require 'evil-commentary)
  (evil-commentary-mode 1)
#+end_src

*** Keybindings

**** Cursor
These remaps make the cursor stay centered in the screen while navigating.
#+begin_src emacs-lisp
  (defun nj/scroll-down ()
    (interactive)
    (evil-scroll-down nil)
    (evil-scroll-line-to-center nil))

  (defun nj/scroll-up ()
    (interactive)
    (evil-scroll-up nil)
    (evil-scroll-line-to-center nil))

  (defun nj/search-next ()
    (interactive)
    (evil-search-next)
    (evil-scroll-line-to-center nil))

  (defun nj/search-previous ()
    (interactive)
    (evil-search-previous)
    (evil-scroll-line-to-center nil))

  (defun nj/up ()
    (interactive)
    (call-interactively 'evil-previous-line)
    (evil-scroll-line-to-center nil))

  (defun nj/down ()
    (interactive)
    (call-interactively 'evil-next-line)
    (evil-scroll-line-to-center nil))

  (evil-define-key 'normal global-map
    (kbd "C-u") 'nj/scroll-up
    (kbd "C-d") 'nj/scroll-down
    (kbd "k") 'nj/up
    (kbd "j") 'nj/down
    (kbd "n") 'nj/search-next
    (kbd "N") 'nj/search-previous)
#+end_src

**** Visual Mode
Stay in visual mode while indenting.
#+begin_src emacs-lisp
  (defun nj/indent-right ()
    (interactive)
    (evil-shift-right (region-beginning) (region-end))
    (evil-normal-state)
    (evil-visual-restore))

  (defun nj/indent-left ()
    (interactive)
    (evil-shift-left (region-beginning) (region-end))
    (evil-normal-state)
    (evil-visual-restore))

  (define-key evil-visual-state-map (kbd ">") 'nj/indent-right)
  (define-key evil-visual-state-map (kbd "<") 'nj/indent-left)
#+end_src

** Yank
Highlight text when yanking.
#+begin_src emacs-lisp
  (defun highlight-on-yank (orig-fn beg end &rest args)
    (apply orig-fn beg end args)
    (let ((ov (make-overlay beg end)))
      (overlay-put ov 'face 'show-paren-mismatch)
      (run-with-timer 0.040 nil 'delete-overlay ov)))

  (advice-add 'evil-yank :around #'highlight-on-yank)
#+end_src

* Visuals
#+begin_src emacs-lisp
  (menu-bar-mode -1)
  (tool-bar-mode -1)
  (scroll-bar-mode -1)
  (blink-cursor-mode -1)
  (set-fringe-mode 0)


  (set-face-attribute 'default nil :weight 'bold)

  (setq display-line-numbers-type 'relative)
  (global-display-line-numbers-mode 1)
  (global-visual-line-mode -1) ;; Disable line wrapping
#+end_src

** Face Attributes
#+begin_src emacs-lisp
  (set-cursor-color (face-foreground 'default)) ;; Theme cursor based on colorscheme

  (set-face-attribute 'line-number nil
                      :background (face-attribute 'default :background))
  (set-face-attribute 'line-number-current-line nil
                      :background (face-attribute 'default :background))

  (set-face-attribute 'mode-line nil
                      :background (face-attribute 'default :background))
  (set-face-attribute 'mode-line-inactive nil
                      :background (face-attribute 'default :background))
#+end_src

** Mode Line
#+begin_src emacs-lisp
  (defun nj/buffer-name ()
    (if (buffer-file-name)
        (if-let* ((p (project-current))
  		(p-root (project-root p))
  		(p-name (project-name p)))
  	  (format "%s/%s" p-name
  		  (file-relative-name (buffer-file-name) p-root))
  	(abbreviate-file-name (buffer-file-name)))
      (buffer-name)))

  (setq-default mode-line-format
  	      '("%e"
  		(" ")
  		(:propertize
  		 (:eval (nj/buffer-name))
  		 face (:inherit default))))
#+end_src

* Keybindings
#+begin_src emacs-lisp
  (require 'general)
  (general-evil-setup)

  (general-create-definer nj/leader-keys
    :states '(normal insert visual emacs)
    :keymaps 'override
    :prefix "SPC"
    :global-prefix "C-SPC")

  (defun nj/compile-interactive ()
    (interactive)
    (let ((current-prefix-arg '(4)))
      (call-interactively 'compile)))

  (nj/leader-keys
    "y" '((lambda () (interactive) (evil-use-register ?+) (call-interactively 'evil-yank)) :wk "Yank to system clipboard")
    "p" '((lambda () (interactive) (evil-paste-from-register ?+)) :wk "Paste from system clipboard")
    "fd" '(find-file :wk "Find file")
    "fs" '(project-find-file :wk "Find project file")
    "fa" '(project-switch-project :wk "Switch projects")
    "fj" '(switch-to-buffer :wk "Switch buffers")
    "sd" '(shell-command :wk "Shell command")
    "sf" '(async-shell-command :wk "Async shell command")
    "cv" '(compile :wk "Compile")
    "ca" '(recompile :wk "Recompile")
    "cf" '(nj/compile-interactive :wk "Compile interactive"))
#+end_src

* WHICH-KEY
#+begin_src emacs-lisp
  (require 'which-key)
  (which-key-mode 1)
#+end_src

* ORG MODE
#+begin_src emacs-lisp
  (setq org-modern-star 'replace)
  (with-eval-after-load 'org (global-org-modern-mode))
  (require 'org-tempo)
  #+end_src

* Defaults
#+begin_src emacs-lisp
  (make-directory (expand-file-name "backup/" user-emacs-directory) t)
  (make-directory (expand-file-name "auto-save/" user-emacs-directory) t)
  (make-directory (expand-file-name "lock/" user-emacs-directory) t)

  (setq backup-directory-alist
  	`(("." . ,(expand-file-name "backup/" user-emacs-directory)))
  	auto-save-file-name-transforms
  	`((".*" ,(expand-file-name "auto-save/" user-emacs-directory) t))
  	lock-file-name-transforms
  	`((".*" ,(expand-file-name "lock/" user-emacs-directory) t))
  	use-short-answers t)

  (add-hook 'before-save-hook 'delete-trailing-whitespace)

  (setq compilation-scroll-output t)

  (require 'diredfl)
  (diredfl-global-mode 1)
  (set-face-attribute 'diredfl-date-time nil :weight 'unspecified :inherit 'default)
#+end_src

* Completions
#+begin_src emacs-lisp
  (fido-vertical-mode)
  (evil-define-key 'insert icomplete-minibuffer-map
    (kbd "C-k") 'icomplete-backward-completions)
  (evil-define-key 'insert icomplete-minibuffer-map
    (kbd "C-j") 'icomplete-forward-completions)
#+end_src
